-- SQL скрипт для создания таблиц в Supabase
-- Выполните этот скрипт в SQL Editor вашего Supabase проекта

CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    password TEXT NOT NULL,
    role VARCHAR(50) DEFAULT 'client' CHECK (role IN ('guest', 'client', 'admin')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Таблица авторов
CREATE TABLE IF NOT EXISTS authors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    biography TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Таблица жанров
CREATE TABLE IF NOT EXISTS genres (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Таблица книг (с авторами и жанрами)
CREATE TABLE IF NOT EXISTS books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    author_id UUID REFERENCES authors(id) ON DELETE SET NULL,
    genre_id UUID REFERENCES genres(id) ON DELETE SET NULL,
    description TEXT,
    content TEXT,
    cover_url TEXT,
    file_url TEXT,
    rating DECIMAL(3, 2) DEFAULT 0.0,
    rating_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Таблица избранного
CREATE TABLE IF NOT EXISTS favorites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    book_id UUID REFERENCES books(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, book_id)
);

-- Индексы для оптимизации запросов
CREATE INDEX IF NOT EXISTS idx_books_genre ON books(genre_id);
CREATE INDEX IF NOT EXISTS idx_books_author ON books(author_id);
CREATE INDEX IF NOT EXISTS idx_favorites_user ON favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_favorites_book ON favorites(book_id);
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_books_title ON books(title);

-- Включить Row Level Security (RLS)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE authors ENABLE ROW LEVEL SECURITY;
ALTER TABLE genres ENABLE ROW LEVEL SECURITY;
ALTER TABLE books ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

-- Политики безопасности для чтения (все могут читать)
CREATE POLICY "Anyone can read books" ON books FOR SELECT USING (true);
CREATE POLICY "Anyone can read authors" ON authors FOR SELECT USING (true);
CREATE POLICY "Anyone can read genres" ON genres FOR SELECT USING (true);

-- Политики для пользователей (открытый доступ, без auth.uid)
CREATE POLICY "Anyone can read users" ON users FOR SELECT USING (true);
CREATE POLICY "Anyone can insert users" ON users FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can update users" ON users FOR UPDATE USING (true);

-- Политики для избранного (открытый доступ, при этом уникальность user_id/book_id сохраняется)
CREATE POLICY "Anyone can read favorites" ON favorites FOR SELECT USING (true);
CREATE POLICY "Anyone can insert favorites" ON favorites FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can delete favorites" ON favorites FOR DELETE USING (true);

-- Политики для администраторов больше не требуются без auth

-- Функция для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Триггеры для автоматического обновления updated_at
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_authors_updated_at BEFORE UPDATE ON authors
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_genres_updated_at BEFORE UPDATE ON genres
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_books_updated_at BEFORE UPDATE ON books
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Вставка тестовых данных (опционально)
-- Вставка жанров (только используемые)
INSERT INTO genres (name, description) VALUES
    ('Фантастика', 'Научная фантастика и фэнтези'),
    ('Детектив', 'Детективные романы и триллеры'),
    ('Роман', 'Романтические произведения'),
    ('История', 'Исторические произведения'),
    ('Классика', 'Классическая литература'),
    ('Поэзия', 'Поэтические произведения'),
    ('Биография', 'Биографические произведения')
ON CONFLICT (name) DO NOTHING;

-- Вставка авторов
INSERT INTO authors (first_name, last_name, biography) VALUES
    ('Лев', 'Толстой', 'Русский писатель, классик мировой литературы'),
    ('Фёдор', 'Достоевский', 'Русский писатель, философ и публицист'),
    ('Александр', 'Пушкин', 'Русский поэт, драматург и прозаик'),
    ('Антон', 'Чехов', 'Русский писатель, драматург, врач'),
    ('Николай', 'Гоголь', 'Русский прозаик, драматург, поэт, критик, публицист'),
    ('Иван', 'Тургенев', 'Русский писатель-реалист, поэт, публицист, драматург, переводчик'),
    ('Михаил', 'Булгаков', 'Русский писатель, драматург, театральный режиссёр и актёр'),
    ('Александр', 'Солженицын', 'Русский писатель, драматург, публицист, поэт, общественный и политический деятель'),
    ('Владимир', 'Набоков', 'Русский и американский писатель, поэт, переводчик, литературовед и энтомолог'),
    ('Борис', 'Пастернак', 'Русский поэт, писатель и переводчик')
ON CONFLICT DO NOTHING;

-- Вставка книг (распределение по жанрам и авторам)
-- Получаем ID жанров и авторов для использования в INSERT
DO $$
DECLARE
    genre_fantasy UUID;
    genre_detective UUID;
    genre_roman UUID;
    genre_history UUID;
    genre_classic UUID;
    genre_poetry UUID;
    genre_biography UUID;
    author_chekhov UUID;
    author_gogol UUID;
    author_pushkin UUID;
    author_turgenev UUID;
    author_tolstoy UUID;
    author_dostoevsky UUID;
    author_bulgakov UUID;
    author_solzhenitsyn UUID;
    author_nabokov UUID;
    author_pasternak UUID;
BEGIN
    -- Получаем ID жанров
    SELECT id INTO genre_fantasy FROM genres WHERE name = 'Фантастика' LIMIT 1;
    SELECT id INTO genre_detective FROM genres WHERE name = 'Детектив' LIMIT 1;
    SELECT id INTO genre_roman FROM genres WHERE name = 'Роман' LIMIT 1;
    SELECT id INTO genre_history FROM genres WHERE name = 'История' LIMIT 1;
    SELECT id INTO genre_classic FROM genres WHERE name = 'Классика' LIMIT 1;
    SELECT id INTO genre_poetry FROM genres WHERE name = 'Поэзия' LIMIT 1;
    SELECT id INTO genre_biography FROM genres WHERE name = 'Биография' LIMIT 1;
    
    -- Получаем ID авторов
    SELECT id INTO author_chekhov FROM authors WHERE first_name = 'Антон' AND last_name = 'Чехов' LIMIT 1;
    SELECT id INTO author_gogol FROM authors WHERE first_name = 'Николай' AND last_name = 'Гоголь' LIMIT 1;
    SELECT id INTO author_pushkin FROM authors WHERE first_name = 'Александр' AND last_name = 'Пушкин' LIMIT 1;
    SELECT id INTO author_turgenev FROM authors WHERE first_name = 'Иван' AND last_name = 'Тургенев' LIMIT 1;
    SELECT id INTO author_tolstoy FROM authors WHERE first_name = 'Лев' AND last_name = 'Толстой' LIMIT 1;
    SELECT id INTO author_dostoevsky FROM authors WHERE first_name = 'Фёдор' AND last_name = 'Достоевский' LIMIT 1;
    SELECT id INTO author_bulgakov FROM authors WHERE first_name = 'Михаил' AND last_name = 'Булгаков' LIMIT 1;
    SELECT id INTO author_solzhenitsyn FROM authors WHERE first_name = 'Александр' AND last_name = 'Солженицын' LIMIT 1;
    SELECT id INTO author_nabokov FROM authors WHERE first_name = 'Владимир' AND last_name = 'Набоков' LIMIT 1;
    SELECT id INTO author_pasternak FROM authors WHERE first_name = 'Борис' AND last_name = 'Пастернак' LIMIT 1;
    
    -- Вставляем книги с распределением по жанрам и авторам
    INSERT INTO books (title, author_id, genre_id, description, content, rating, rating_count) VALUES
        -- Классика
        ('Хамелеон', author_chekhov, genre_classic,
         'Короткий рассказ о полицейском надзирателе, который меняет своё мнение в зависимости от обстоятельств.',
         'Надзиратель Очумелов в новом пальто и с узелком в руке идёт через базарную площадь. За ним шагает рыжий городовой с решетом, доверху наполненным конфискованным крыжовником. Кругом тишина... На площади ни души... Открытые двери лавок и кабаков глядят на свет божий уныло, как голодные пасти; около них нет даже нищих. "Так ты кусаешься, проклятый?" — слышит вдруг Очумелов. Собачий визг. Очумелов глядит в сторону и видит: из дровяного склада купца Пичугина, прыгая на трёх ногах и оглядываясь, бежит собака. За ней гонится человек в ситцевой крахмальной рубахе и расстёгнутой жилетке. Он бежит за ней и, наклонившись вперёд, падает на землю и хватает собаку за задние лапы. Снова слышен собачий визг и крик: "Не пущу!" Сонные физиономии высовываются из лавок, и скоро около дровяного склада, как будто из земли выросла, собирается толпа.',
         4.7, 850),
        ('Толстый и тонкий', author_chekhov, genre_classic,
         'Рассказ о встрече двух старых друзей, один из которых стал важным чиновником.',
         'На вокзале Николаевской железной дороги встретились два приятеля: один толстый, другой тонкий. Толстый только что пообедал на вокзале, и губы его, подёрнутые маслом, лоснились, как спелые вишни. Пахло от него хересом и флёр-д''оранжем. Тонкий же только что вышел из вагона и был навьючен чемоданами, узлами и картонками. Пахло от него ветчиной и кофейной гущей. Из-за его спины выглядывала худенькая женщина с длинным подбородком — его жена, и высокий гимназист с прищуренным глазом — его сын.',
         4.6, 720),
        ('Станционный смотритель', author_pushkin, genre_classic,
         'Повесть о станционном смотрителе и его дочери, сбежавшей с гусаром.',
         'Коллежский регистратор, почтовой станции диктатор. Кто не проклинал станционных смотрителей, кто с ними не бранивался? Кто в минуту гнева не требовал от них роковой книги, дабы вписать в оную свою бесполезную жалобу на притеснение, грубость и неисправность? Кто не почитает их извергами человеческого рода, равными покойным подьячим или, по крайней мере, муромским разбойникам? Будем, однако, справедливы, постараемся войти в их положение и, может быть, станем судить о них гораздо снисходительнее.',
         4.8, 950),
        ('Нос', author_gogol, genre_classic,
         'Фантастическая повесть о майоре Ковалёве, у которого пропал нос.',
         'Марта 25 числа случилось в Петербурге необыкновенно странное происшествие. Цирюльник Иван Яковлевич, живущий на Вознесенском проспекте (фамилия его утрачена, и даже на вывеске его — где изображён господин с намыленной щекой и надпись: "И кровь отворяют" — не выставлено ничего более), цирюльник Иван Яковлевич проснулся довольно рано и услышал запах горячего хлеба. Приподнявшись немного на кровати, он увидел, что супруга его, почтенная дама, очень любившая пить кофе, вынимала из печи только что испечённые хлебы.',
         4.7, 880),
        ('Шинель', author_gogol, genre_classic,
         'Повесть о мелком чиновнике Акакие Акакиевиче Башмачкине и его новой шинели.',
         'В департаменте... но лучше не называть, в каком департаменте. Нет ничего сердитее всякого рода департаментов, полков, канцелярий и, словом, всякого рода должностных сословий. Теперь уже всякий частный человек считает в лице своём оскорблённым всё общество. Говорят, очень недавно поступила просьба от одного капитана-исправника, не помню какого-то города, в которой он излагает ясно, что гибнут государственные постановления и что священное имя его произносится совершенно всуе. И в доказательство приложил он к просьбе преобъёмистый том какого-то романтического сочинения, где, кажется, на каждой десятой странице является капитан-исправник.',
         4.9, 1200),
        ('Муму', author_turgenev, genre_classic,
         'Рассказ о глухонемом дворнике Герасиме и его собаке Муму.',
         'В одной из отдалённых улиц Москвы, в сером доме с белыми колоннами, антресолью и покривившимся балконом, жила некогда барыня, вдова, окружённая многочисленною дворней. Сыновья её служили в Петербурге, дочери вышли замуж; она выезжала редко и уединённо доживала последние годы своей скупой и скучающей старости. День её, нерадостный и ненастный, давно прошёл; но и вечер её был чернее ночи.',
         4.8, 1100),
        ('Белые ночи', author_dostoevsky, genre_classic,
         'Сентиментальный роман о мечтателе и его встрече с Настенькой.',
         'Была чудная ночь, такая ночь, которая разве только и может быть тогда, когда мы молоды, любезный читатель. Небо было такое звёздное, такое светлое небо, что, взглянув на него, невольно нужно было спросить себя: неужели же могут жить под таким небом разные сердитые и капризные люди? Это тоже молодой вопрос, любезный читатель, очень молодой, но да принесёт вам господь почаще его задавать!..',
         4.7, 980),
        ('Каштанка', author_chekhov, genre_classic,
         'Рассказ о собаке Каштанке, которая потеряла хозяина и попала к цирковому артисту.',
         'Молодая рыжая собака — помесь такса с дворняжкой — очень похожая мордой на лисицу, бегала взад и вперёд по тротуару и беспокойно оглядывалась по сторонам. Изредка она останавливалась и, плача, приподнимая то одну озябшую лапу, то другую, старалась дать себе отчёт: как это могло случиться, что она заблудилась?',
         4.6, 750),
        ('Дубровский', author_pushkin, genre_classic,
         'Неоконченный роман о благородном разбойнике Владимире Дубровском.',
         'Несколько лет тому назад в одном из своих поместий жил старинный русский барин, Кирила Петрович Троекуров. Его богатство, знатный род и связи давали ему большой вес в губерниях, где находилось его имение. Соседи рады были угождать малейшим его прихотям; губернские чиновники трепетали при его имени; Кирила Петрович принимал знаки подобострастия как надлежащую дань; дом его всегда был полон гостями, готовыми тешить его барскую праздность, разделяя шумные, а иногда и буйные увеселения.',
         4.8, 1050),
        ('Война и мир', author_tolstoy, genre_classic,
         'Эпический роман о русском обществе в эпоху наполеоновских войн.',
         '— Eh bien, mon prince, Gênes et Lucques ne sont plus que des apanages, des поместья, de la famille Buonaparte. Non, je vous préviens, que si vous ne me dites pas, que nous avons la guerre, si vous vous permettez encore de pallier toutes les infamies, toutes les atrocités de cet Antichrist (ma parole, j''y crois) — je ne vous connais plus, vous n''êtes plus mon ami, vous n''êtes plus мой верный раб, comme vous dites.',
         4.9, 2500),
        ('Преступление и наказание', author_dostoevsky, genre_classic,
         'Психологический роман о студенте Раскольникове и его преступлении.',
         'В начале июля, в чрезвычайно жаркое время, под вечер, один молодой человек вышел из своей каморки, которую нанимал от жильцов в С-м переулке, на улицу и медленно, как бы в нерешительности, отправился к К-ну мосту.',
         4.8, 2200),
        ('Анна Каренина', author_tolstoy, genre_classic,
         'Роман о трагической любви замужней дамы Анны Карениной и блестящего офицера Вронского.',
         'Все счастливые семьи похожи друг на друга, каждая несчастливая семья несчастлива по-своему. Всё смешалось в доме Облонских. Жена узнала, что муж был в связи с бывшею в их доме француженкою-гувернанткой, и объявила мужу, что не может жить с ним в одном доме.',
         4.9, 2100),
        ('Евгений Онегин', author_pushkin, genre_classic,
         'Роман в стихах о жизни светского общества первой половины XIX века.',
         'Мой дядя самых честных правил, Когда не в шутку занемог, Он уважать себя заставил И лучше выдумать не мог. Его пример другим наука; Но, боже мой, какая скука С больным сидеть и день и ночь, Не отходя ни шага прочь!',
         4.8, 1800),
        ('Отцы и дети', author_turgenev, genre_classic,
         'Роман о конфликте поколений и нигилизме в русском обществе.',
         '— Что, Петр, не видать еще? — спрашивал 20 мая 1859 года, выходя без шапки на низкое крылечко постоялого двора на *** шоссе, барин лет сорока с небольшим, в запыленном пальто и клетчатых панталонах, у своего слуги, молодого и щекастого малого с беловатым пухом на подбородке и маленькими тусклыми глазками.',
         4.7, 1600),
        ('Идиот', author_dostoevsky, genre_classic,
         'Роман о князе Мышкине, олицетворении добра и христианской любви.',
         'В конце ноября, в оттепель, часов в девять утра, поезд Петербургско-Варшавской железной дороги на всех парах подходил к Петербургу. Было так сыро и туманно, что насилу рассвело; в десяти шагах, вправо и влево от дороги, трудно было разглядеть хоть что-нибудь из окон вагона.',
         4.8, 1900),
        ('Братья Карамазовы', author_dostoevsky, genre_classic,
         'Философский роман о трёх братьях и их отце, затрагивающий вопросы веры и морали.',
         'Алексей Фёдорович Карамазов был третьим сыном помещика нашего уезда Фёдора Павловича Карамазова, столь известного в своё время (и до сих пор у нас припоминаемого) по трагической и тёмной кончине своей, случившейся ровно тринадцать лет назад и о которой я сообщу в своём месте.',
         4.9, 2400),
        ('Обломов', author_turgenev, genre_classic,
         'Роман о русском помещике Илье Ильиче Обломове и его ленивой жизни.',
         'В Гороховой улице, в одном из больших домов, народонаселения которого стало бы на целый уездный город, лежал утром в постели, на своей квартире, Илья Ильич Обломов.',
         4.7, 1700),
        ('Герой нашего времени', author_pushkin, genre_classic,
         'Роман о молодом офицере Печорине, типичном представителе своего поколения.',
         'Недавно узнал я, что Печорин, возвращаясь из Персии, умер. Это известие меня очень обрадовало: оно давало мне право печатать эти записки, и я воспользовался случаем поставить своё имя над чужим произведением. Бог да простит мне эту невинную шутку!',
         4.8, 1500),
        ('Мёртвые души', author_gogol, genre_classic,
         'Поэма о похождениях Чичикова, скупающего мёртвые души крепостных крестьян.',
         'В ворота гостиницы губернского города NN въехала довольно красивая рессорная небольшая бричка, в какой ездят холостяки: отставные подполковники, штабс-капитаны, помещики, имеющие около сотни душ крестьян, — словом, все те, которых называют господами средней руки.',
         4.8, 1400),
        ('Капитанская дочка', author_pushkin, genre_classic,
         'Исторический роман о событиях Пугачёвского восстания.',
         'Отец мой Андрей Петрович Гринёв в молодости своей служил при графе Минихе и вышел в отставку премьер-майором в 17.. году. С тех пор жил он в своей Симбирской деревне, где и женился на девице Авдотье Васильевне Ю., дочери бедного тамошнего дворянина.',
         4.7, 1300),
        ('Гроза', author_chekhov, genre_classic,
         'Драма о конфликте между старым и новым укладом жизни в провинциальном городе.',
         'Действие происходит в городе Калинове, на берегу Волги, летом, в 10-х годах XIX века. Между третьим и четвертым действиями проходит 10 дней.',
         4.6, 1200),
        ('Ревизор', author_gogol, genre_classic,
         'Комедия о чиновниках, принявших проезжего за ревизора.',
         'Я пригласил вас, господа, с тем, чтобы сообщить вам пренеприятное известие: к нам едет ревизор.',
         4.8, 1100),
        ('Тарас Бульба', author_gogol, genre_classic,
         'Повесть о запорожских казаках и их борьбе с поляками.',
         '— Поворотись-ка, сынку! Экой ты смешной какой! Что это на вас за поповские подрясники? И эдак все ходят в академии?',
         4.7, 1000),
        ('Вишнёвый сад', author_chekhov, genre_classic,
         'Пьеса о продаже родового имения и смене эпох.',
         'Комната, которую до сих пор называют детскою. Одна из дверей ведёт в комнату Ани. Рассвет, скоро взойдёт солнце. Уже май, цветут вишнёвые деревья, но в саду холодно, утренний мороз.',
         4.7, 950),
        ('Три сестры', author_chekhov, genre_classic,
         'Драма о трёх сёстрах, мечтающих о переезде в Москву.',
         'Гостиная в доме Прозоровых. Большой стол, за которым завтракают. Ольга, Маша и Ирина.',
         4.6, 900),
        ('Чайка', author_chekhov, genre_classic,
         'Пьеса о любви, искусстве и конфликте поколений.',
         'Декорация первого действия: часть парка в имении Сорина. Широкая аллея, ведущая от зрителей в глубину сада к озеру, загорожена эстрадой, временно сколоченной для домашнего спектакля, так что озера совсем не видно.',
         4.7, 850),
        
        -- Фантастика
        ('Собачье сердце', author_bulgakov, genre_fantasy,
         'Повесть о научном эксперименте профессора Преображенского по превращению собаки в человека.',
         'У-у-у-у-у-у-у-у-гу-гу-гу! О, гляньте на меня, я погибаю. Вьюга в подворотне ревёт мне отходную, и я вою вместе с ней. Погибаю. Кто-то злой швырнул меня в подворотню, и я разбил себе голову о забор. И теперь мне всё равно. Пусть я умру. Я голоден, и мне холодно, и я вою, а вьюга воет, и оба мы завидуем... кому-то... Я хочу есть, только есть...',
         4.9, 1500),
        ('Мастер и Маргарита', author_bulgakov, genre_fantasy,
         'Философский роман о дьяволе, посетившем Москву, и истории мастера.',
         'В час жаркого весеннего заката на Патриарших прудах появились два гражданина. Первый из них — приблизительно сорокалетний, одетый в серенькую летнюю пару, был маленького роста, темноволос, упитан, лыс, нёс приличную шляпу пирожком в руке, а на хорошо выбритом лице его помещались сверхъестественных размеров очки в чёрной роговой оправе.',
         4.9, 2800),
        ('Роковые яйца', author_bulgakov, genre_fantasy,
         'Фантастическая повесть о научном эксперименте, вышедшем из-под контроля.',
         '16 апреля 1928 года вечером профессор Персиков, заведующий зоологическим институтом в Москве, вошёл в свой кабинет, расположенный в зоологическом институте на улице Герцена.',
         4.6, 1200),
        
        -- Роман
        ('Доктор Живаго', author_pasternak, genre_roman,
         'Роман о жизни врача и поэта Юрия Живаго в период революции и Гражданской войны.',
         'Шли и шли и пели "Вечную память", и когда останавливались, казалось, что её по заведённому порядку продолжают петь ноги, лошади, дуновения ветра.',
         4.8, 2000),
        ('Лолита', author_nabokov, genre_roman,
         'Роман о трагической страсти и моральных границах.',
         'Лолита, свет моей жизни, огонь моих чресел. Грех мой, душа моя. Ло-ли-та: кончик языка совершает путь в три шажка вниз по нёбу, чтобы в третий раз постучать о зубы. Ло. Ли. Та.',
         4.6, 1800),
        ('Двенадцать стульев', author_bulgakov, genre_roman,
         'Роман о поисках сокровищ, спрятанных в одном из двенадцати стульев.',
         'В уездном городе N было так много парикмахерских заведений и бюро похоронных процессий, что, казалось, жители города рождаются лишь затем, чтобы побриться, остричься, освежить голову вежеталем и сразу же умереть.',
         4.8, 1900),
        ('Золотой телёнок', author_bulgakov, genre_roman,
         'Продолжение приключений Остапа Бендера в поисках миллиона.',
         'В городе Арбатове, в доме номер тринадцать по улице Пушкина, жил гражданин Корейко.',
         4.7, 1800),
        ('Доктор Фаустус', author_bulgakov, genre_roman,
         'Роман о композиторе и его сделке с дьяволом.',
         'Я намерен рассказать вам историю Адриана Леверкюна, как я её знаю, как я её наблюдал и как она мне открылась из его собственных уст и из документов.',
         4.7, 1600),
        ('Смерть в Венеции', author_nabokov, genre_roman,
         'Повесть о стареющем писателе и его роковой страсти.',
         'Густав Ашенбах, или фон Ашенбах, как он официально именовался с пятидесятого года жизни, в один ясный весенний день 19... года, когда Европа уже долгое время находилась в таком тревожном состоянии, что угрожала безопасности, вышел из своей мюнхенской квартиры на Принцрегентенштрассе и отправился на длительную прогулку.',
         4.6, 1300),
        
        -- История
        ('Белая гвардия', author_bulgakov, genre_history,
         'Роман о семье Турбиных в период Гражданской войны на Украине.',
         'Велик был год и страшен год по Рождестве Христовом 1918, от начала же революции второй.',
         4.7, 1500),
        
        -- Биография
        ('Один день Ивана Денисовича', author_solzhenitsyn, genre_biography,
         'Повесть о жизни заключённого в сталинском лагере.',
         'В пять часов утра, как всегда, пробило подъём — молотком об рельс у штабного барака.',
         4.7, 1600),
        ('Архипелаг ГУЛАГ', author_solzhenitsyn, genre_biography,
         'Документально-художественное произведение о системе лагерей в СССР.',
         'Арестовать? Нет, не так. Арест — это мгновенный перелом, щелчок, от которого настоящее мгновенно превращается в прошлое, а невозможное — в реальность.',
         4.9, 2300),
        
        -- Поэзия
        ('Двенадцать', author_pushkin, genre_poetry,
         'Поэма о революции и её участниках.',
         'Чёрный вечер. Белый снег. Ветер, ветер! На ногах не стоит человек.',
         4.6, 1000),
        ('Незнакомка', author_pushkin, genre_poetry,
         'Стихотворение о таинственной незнакомке в ресторане.',
         'По вечерам над ресторанами Горячий воздух дик и глух, И правит окриками пьяными Весенний и тлетворный дух.',
         4.5, 800),
        ('Стихи о прекрасной даме', author_pushkin, genre_poetry,
         'Цикл стихотворений, посвящённых возлюбленной.',
         'Вхожу я в тёмные храмы, Совершаю бедный обряд. Там жду я Прекрасной Дамы В мерцаньи красных лампад.',
         4.6, 900),
        
        -- Детектив
        ('Записки из подполья', author_dostoevsky, genre_detective,
         'Философская повесть о человеке, отвергающем общество и его ценности.',
         'Я человек больной... Я злой человек. Непривлекательный я человек. Я думаю, что у меня болит печень.',
         4.7, 1400),
        ('Бесы', author_dostoevsky, genre_detective,
         'Роман о революционном движении и терроризме в России.',
         'В конце ноября, во время оттепели, часов в девять утра, поезд Петербургско-Варшавской железной дороги на всех парах подходил к Петербургу.',
         4.8, 1700),
        ('Игрок', author_dostoevsky, genre_detective,
         'Роман о страсти к азартным играм и её разрушительной силе.',
         'Наконец я вернулся из моего двухнедельного отсутствия. Наши уже три дня как в Рулетенбурге.',
         4.6, 1100)
    ON CONFLICT DO NOTHING;
END $$;

-- Миграция: добавление колонки author_id, если её нет
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'books' AND column_name = 'author_id'
    ) THEN
        ALTER TABLE books ADD COLUMN author_id UUID REFERENCES authors(id) ON DELETE SET NULL;
        CREATE INDEX IF NOT EXISTS idx_books_author ON books(author_id);
    END IF;
END $$;

-- Очистка и обновление данных
-- Удаление неиспользуемых жанров (жанры, которые не используются ни в одной книге)
DELETE FROM genres 
WHERE id NOT IN (
    SELECT DISTINCT genre_id 
    FROM books 
    WHERE genre_id IS NOT NULL
);

-- Назначение жанров книгам без genre_id
-- Назначаем жанр "Классика" как дефолтный для всех книг без жанра
DO $$
DECLARE
    genre_classic UUID;
BEGIN
    -- Получаем ID жанра "Классика"
    SELECT id INTO genre_classic FROM genres WHERE name = 'Классика' LIMIT 1;
    
    -- Если жанр "Классика" существует, назначаем его всем книгам без жанра
    IF genre_classic IS NOT NULL THEN
        UPDATE books 
        SET genre_id = genre_classic
        WHERE genre_id IS NULL;
    ELSE
        -- Если жанр "Классика" не найден, используем первый доступный жанр
        UPDATE books 
        SET genre_id = (SELECT id FROM genres LIMIT 1)
        WHERE genre_id IS NULL
        AND EXISTS (SELECT 1 FROM genres);
    END IF;
END $$;

